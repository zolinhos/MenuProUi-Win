name: Build MSI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Vers√£o do MSI (ex: 1.0.1)'
        required: false
        default: '1.0.1'
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Install WiX Toolset (Chocolatey)
        shell: powershell
        run: |
          choco install wixtoolset -y

      - name: Show WiX tools
        shell: powershell
        run: |
          Get-Command heat,candle,light -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.Path }

      - name: Build MSI
        shell: powershell
        run: |
          $ver = '${{ github.event.inputs.version }}'
          if ([string]::IsNullOrWhiteSpace($ver)) { $ver = '${{ github.ref_name }}'.TrimStart('v') }
          if ([string]::IsNullOrWhiteSpace($ver)) { $ver = '1.0.1' }
          Write-Host "Building MSI version: $ver"
          .\Installer\build-msi.ps1 -Version $ver

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: msi
          path: Installer\dist\*.msi

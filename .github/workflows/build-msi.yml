name: Release Windows Dist

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Versão da release (ex: 1.7.3)'
        required: false
        default: '1.7.3'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-dist:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install WiX Toolset (Chocolatey)
        shell: powershell
        run: |
          choco install wixtoolset -y

      - name: Show WiX tools
        shell: powershell
        run: |
          Get-Command heat,candle,light -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.Path }

      - name: Resolve version
        id: version
        shell: powershell
        run: |
          $inputVersion = '${{ github.event.inputs.version }}'
          $tagVersion = '${{ github.ref_name }}'.TrimStart('v')

          if (-not [string]::IsNullOrWhiteSpace($inputVersion)) {
            $version = $inputVersion
          } elseif (-not [string]::IsNullOrWhiteSpace($tagVersion)) {
            $version = $tagVersion
          } else {
            $version = '1.7.3'
          }

          Write-Host "Version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Build dist (ZIP + MSI + checksums)
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          Write-Host "Building dist version: $ver"
          .\build-dist-win.ps1 -Version $ver -Runtime win-x64 -BuildInstaller

      - name: Generate release notes
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          $tag = "v$ver"
          $notes = @"
MenuProUI-Win $ver

## Arquivos
- MenuProUI-$ver-win-x64.zip
- MenuProUI-$ver-x64.msi
- SHA256SUMS
- SHA512SUMS

## Instalação
1. Baixe e execute o instalador MSI.
2. Alternativa: use o ZIP portável e execute MenuProUI.exe.

## Integridade
Valide os hashes com os arquivos SHA256SUMS/SHA512SUMS incluídos.
"@
          $notesPath = "dist/release_notes_$tag.md"
          $notes | Set-Content -Path $notesPath -Encoding UTF8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist-${{ steps.version.outputs.version }}
          path: |
            dist\*.zip
            dist\*.msi
            dist\SHA256SUMS
            dist\SHA512SUMS
            dist\release_notes_*.md

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          body_path: dist/release_notes_${{ github.ref_name }}.md
          files: |
            dist/*.zip
            dist/*.msi
            dist/SHA256SUMS
            dist/SHA512SUMS

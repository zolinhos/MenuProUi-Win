name: Release Windows Dist

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Versão da release (ex: 1.7.3)'
        required: false
        default: '1.7.3'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-dist:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install WiX Toolset (Chocolatey)
        shell: powershell
        run: |
          choco install wixtoolset -y

      - name: Show WiX tools
        shell: powershell
        run: |
          Get-Command heat,candle,light -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.Path }

      - name: Resolve version
        id: version
        shell: powershell
        run: |
          $inputVersion = '${{ github.event.inputs.version }}'
          $tagVersion = '${{ github.ref_name }}'.TrimStart('v')

          if (-not [string]::IsNullOrWhiteSpace($inputVersion)) {
            $version = $inputVersion
          } elseif (-not [string]::IsNullOrWhiteSpace($tagVersion)) {
            $version = $tagVersion
          } else {
            $version = '1.7.3'
          }

          Write-Host "Version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Build MSI
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          Write-Host "Building MSI version: $ver"
          .\Installer\build-msi.ps1 -Version $ver

      - name: Build ZIP dist
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          $distDir = Join-Path $PWD 'dist'
          $publishDir = Join-Path $PWD 'publish\win-x64'
          $zipOut = Join-Path $distDir ("MenuProUI-" + $ver + "-win-x64.zip")

          New-Item -ItemType Directory -Path $distDir -Force | Out-Null
          if (Test-Path $zipOut) { Remove-Item $zipOut -Force }
          Compress-Archive -Path (Join-Path $publishDir '*') -DestinationPath $zipOut -Force

      - name: Build checksums
        shell: powershell
        run: |
          $distDir = Join-Path $PWD 'dist'
          $artifacts = Get-ChildItem -Path $distDir -File | Where-Object {
            $_.Extension -in '.zip', '.msi'
          } | Sort-Object Name

          $sha256Lines = @()
          $sha512Lines = @()

          foreach ($artifact in $artifacts) {
            $h256 = Get-FileHash -Path $artifact.FullName -Algorithm SHA256
            $h512 = Get-FileHash -Path $artifact.FullName -Algorithm SHA512

            $sha256Lines += ("{0}  {1}" -f $h256.Hash.ToLowerInvariant(), $artifact.Name)
            $sha512Lines += ("{0}  {1}" -f $h512.Hash.ToLowerInvariant(), $artifact.Name)
          }

          Set-Content -Path (Join-Path $distDir 'SHA256SUMS') -Value $sha256Lines -Encoding UTF8
          Set-Content -Path (Join-Path $distDir 'SHA512SUMS') -Value $sha512Lines -Encoding UTF8

      - name: Generate release notes
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          $tag = "v$ver"
          $notes = @(
            "MenuProUI-Win $ver",
            "",
            "## Arquivos",
            "- MenuProUI-$ver-win-x64.zip",
            "- MenuProUI-$ver-x64.msi",
            "- SHA256SUMS",
            "- SHA512SUMS",
            "",
            "## Instalação",
            "1. Baixe e execute o instalador MSI.",
            "2. Alternativa: use o ZIP portável e execute MenuProUI.exe.",
            "",
            "## Integridade",
            "Valide os hashes com os arquivos SHA256SUMS/SHA512SUMS incluídos."
          ) -join "`n"
          $notesPath = "dist/release_notes_$tag.md"
          $notes | Set-Content -Path $notesPath -Encoding UTF8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist-${{ steps.version.outputs.version }}
          path: |
            dist\*.zip
            dist\*.msi
            dist\SHA256SUMS
            dist\SHA512SUMS
            dist\release_notes_*.md

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          body_path: dist/release_notes_${{ github.ref_name }}.md
          files: |
            dist/*.zip
            dist/*.msi
            dist/SHA256SUMS
            dist/SHA512SUMS

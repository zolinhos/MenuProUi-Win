name: Release Windows Dist

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Versão da release (ex: 1.7.3)'
        required: false
        default: '1.7.3'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-dist:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install WiX Toolset (Chocolatey)
        shell: powershell
        run: |
          choco install wixtoolset -y

      - name: Ensure WiX on PATH
        shell: powershell
        run: |
          $candidates = @(
            "$env:ProgramFiles(x86)\WiX Toolset v3.14\bin",
            "$env:ProgramFiles(x86)\WiX Toolset v3.11\bin",
            "C:\ProgramData\chocolatey\lib\wixtoolset\tools",
            "C:\ProgramData\chocolatey\bin"
          )

          foreach ($path in $candidates) {
            if (Test-Path $path) {
              Write-Host "Adding to PATH: $path"
              $path | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
            }
          }

      - name: Show WiX tools
        shell: powershell
        run: |
          $tools = Get-Command heat,candle,light -ErrorAction SilentlyContinue
          if (-not $tools -or $tools.Count -lt 3) {
            Write-Host "WiX tools not found on PATH"
            Write-Host "Current PATH: $env:PATH"
            throw "heat/candle/light não encontrados"
          }
          $tools | ForEach-Object { Write-Host $_.Path }

      - name: Resolve version
        id: version
        shell: powershell
        run: |
          $inputVersion = '${{ github.event.inputs.version }}'
          $tagVersion = '${{ github.ref_name }}'.TrimStart('v')

          if (-not [string]::IsNullOrWhiteSpace($inputVersion)) {
            $version = $inputVersion
          } elseif (-not [string]::IsNullOrWhiteSpace($tagVersion)) {
            $version = $tagVersion
          } else {
            $version = '1.7.3'
          }

          Write-Host "Version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Build MSI
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          $root = $PWD
          $publishDir = Join-Path $root 'publish\win-x64'
          $distDir = Join-Path $root 'dist'
          $objDir = Join-Path $root 'Installer\obj'
          $appFiles = Join-Path $root 'Installer\AppFiles.wxs'
          $productTemplate = Join-Path $root 'Installer\Product.wxs'
          $productCi = Join-Path $root 'Installer\Product.ci.wxs'

          New-Item -ItemType Directory -Path $publishDir -Force | Out-Null
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null
          New-Item -ItemType Directory -Path $objDir -Force | Out-Null

          Write-Host "Publishing win-x64..."
          dotnet publish .\MenuProUI.csproj -c Release -r win-x64 --self-contained true -o $publishDir
          if ($LASTEXITCODE -ne 0) { throw "dotnet publish falhou" }

          Write-Host "Harvesting files with heat..."
          heat dir $publishDir -gg -cg AppFiles -dr INSTALLFOLDER -srd -scom -sreg -var var.SourceDir -out $appFiles
          if ($LASTEXITCODE -ne 0) { throw "heat falhou" }

          if (-not (Test-Path $productTemplate)) { throw "Template Product.wxs não encontrado" }
          $product = Get-Content -Path $productTemplate -Raw
          $product = $product.Replace('__VERSION__', $ver)
          $product = $product.Replace('..\\Assets\\menupro-ui.ico', (Join-Path $root 'Assets\\menupro-ui.ico'))
          $product = $product.Replace('Source="README-DEPENDENCIAS.txt"', ('Source="' + (Join-Path $root 'Installer\\README-DEPENDENCIAS.txt') + '"'))
          Set-Content -Path $productCi -Value $product -Encoding UTF8

          Write-Host "Compiling wix objects with candle..."
          candle -nologo -dSourceDir=$publishDir -out (Join-Path $objDir '') $productCi $appFiles
          if ($LASTEXITCODE -ne 0) { throw "candle falhou" }

          $msiOut = Join-Path $distDir ("MenuProUI-" + $ver + "-x64.msi")
          Write-Host "Linking MSI with light..."
          light -nologo -sval -ext WixUIExtension -ext WixUtilExtension -out $msiOut (Join-Path $objDir 'Product.ci.wixobj') (Join-Path $objDir 'AppFiles.wixobj')
          if ($LASTEXITCODE -ne 0) { throw "light falhou" }

          Write-Host "MSI criado em $msiOut"

      - name: Build ZIP dist
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          $distDir = Join-Path $PWD 'dist'
          $publishDir = Join-Path $PWD 'publish\win-x64'
          $zipOut = Join-Path $distDir ("MenuProUI-" + $ver + "-win-x64.zip")

          New-Item -ItemType Directory -Path $distDir -Force | Out-Null
          if (Test-Path $zipOut) { Remove-Item $zipOut -Force }
          Compress-Archive -Path (Join-Path $publishDir '*') -DestinationPath $zipOut -Force

      - name: Build checksums
        shell: powershell
        run: |
          $distDir = Join-Path $PWD 'dist'
          $artifacts = Get-ChildItem -Path $distDir -File | Where-Object {
            $_.Extension -in '.zip', '.msi'
          } | Sort-Object Name

          $sha256Lines = @()
          $sha512Lines = @()

          foreach ($artifact in $artifacts) {
            $h256 = Get-FileHash -Path $artifact.FullName -Algorithm SHA256
            $h512 = Get-FileHash -Path $artifact.FullName -Algorithm SHA512

            $sha256Lines += ("{0}  {1}" -f $h256.Hash.ToLowerInvariant(), $artifact.Name)
            $sha512Lines += ("{0}  {1}" -f $h512.Hash.ToLowerInvariant(), $artifact.Name)
          }

          Set-Content -Path (Join-Path $distDir 'SHA256SUMS') -Value $sha256Lines -Encoding UTF8
          Set-Content -Path (Join-Path $distDir 'SHA512SUMS') -Value $sha512Lines -Encoding UTF8

      - name: Generate release notes
        shell: powershell
        run: |
          $ver = '${{ steps.version.outputs.version }}'
          $tag = "v$ver"
          $notes = @(
            "MenuProUI-Win $ver",
            "",
            "## Arquivos",
            "- MenuProUI-$ver-win-x64.zip",
            "- MenuProUI-$ver-x64.msi",
            "- SHA256SUMS",
            "- SHA512SUMS",
            "",
            "## Instalação",
            "1. Baixe e execute o instalador MSI.",
            "2. Alternativa: use o ZIP portável e execute MenuProUI.exe.",
            "",
            "## Integridade",
            "Valide os hashes com os arquivos SHA256SUMS/SHA512SUMS incluídos."
          ) -join "`n"
          $notesPath = "dist/release_notes_$tag.md"
          $notes | Set-Content -Path $notesPath -Encoding UTF8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist-${{ steps.version.outputs.version }}
          path: |
            dist\*.zip
            dist\*.msi
            dist\SHA256SUMS
            dist\SHA512SUMS
            dist\release_notes_*.md

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          body_path: dist/release_notes_${{ github.ref_name }}.md
          files: |
            dist/*.zip
            dist/*.msi
            dist/SHA256SUMS
            dist/SHA512SUMS
